/*! Localisr - v0.1.2 - 2012-09-15
* http://github.com/IneffablePigeon/Localisr
* Copyright (c) 2012 Giles Lavelle, Oliver Lane; Licensed MIT */
(function(){window.Localisr=window.Localisr||{};var e="(^|\\s)+",t="($|\\s)+",n=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[e[n]]=n);return t},r={position:"absolute",left:0,background:"#eee",border:"1px solid #222",padding:"5px",display:"none",zIndex:9999},i=function(e,t,n){var i=$("<span>").addClass("converted-value-hover").css(r).text("Original "+n+": "+e),s=$("<span>").text(t).addClass("converted-value").css("position","relative").append(i);return $("<div>").html(s).html()},s,o,u,a,f,l,c,h=function(e,t,n){n=n||":";var r,i,o,u=s[t],a=s[c],f=u.offset-a.offset,l=p(f);e.match(/am|pm/i)?o="hh"+n+"mm a":o="HH"+n+"mm",i=o,r=o+" Z";var h=e.substring(0,e.length-4)+l,d=moment(h,r);return d.local(),d.format(i)+" "+c},p=function(e){console.log(e);var t="";e<0?(t+="-",e*=-1):t+="+",e<10&&(t+="0"),t+=Math.floor(e),e-=Math.floor(e);if(e>.01){var n=Math.round(e*60);n<10?(t+="0",t+=n):t+=n}else t+="00";return console.log(t),t},d,v,m=["AED","AFN","ALL","AMD","ANG","AOA","ARS","AUD","AWG","AZN","BAM","BBD","BDT","BGN","BHD","BIF","BMD","BND","BOB","BRL","BSD","BTN","BWP","BYR","BZD","CAD","CDF","CHF","CLF","CLP","CNY","COP","CRC","CUP","CVE","CZK","DJF","DKK","DOP","DZD","EGP","ETB","EUR","FJD","FKP","GBP","GEL","GHS","GIP","GMD","GNF","GTQ","GYD","HKD","HNL","HRK","HTG","HUF","IDR","ILS","INR","IQD","IRR","ISK","JMD","JOD","JPY","KES","KGS","KHR","KMF","KPW","KRW","KWD","KZT","LAK","LBP","LKR","LRD","LSL","LTL","LVL","LYD","MAD","MDL","MGA","MKD","MMK","MNT","MOP","MRO","MUR","MVR","MWK","MXN","MYR","MZN","NAD","NGN","NIO","NOK","NPR","NZD","OMR","PAB","PEN","PGK","PHP","PKR","PLN","PYG","QAR","RON","RSD","RUB","RWF","SAR","SBD","SCR","SDG","SEK","SGD","SHP","SLL","SOS","SRD","STD","SVC","SYP","SZL","THB","TJS","TMT","TND","TOP","TRY","TTD","TWD","TZS","UAH","UGX","USD","UYU","UZS","VEF","VND","VUV","WST","XAF","XCD","XDR","XOF","XPF","YER","ZAR","ZMK","ZWL"],g=["£","€","¥","$"],y=[],b,w="[0-9]+\\.?([0-9]{2})?";for(b=0;b<m.length;b++)y.push(m[b]);for(b=0;b<g.length;b++){var E=g[b];E==="$"&&(E="\\$"),y.push(E)}var S="("+y.join("|")+"){1}",x=S+"\\s*"+w,T=new RegExp(e+x+t,"g"),N=new RegExp(x,"g"),C=new RegExp(S,"g"),k={"£":"GBP",$:"USD","€":"EUR","¥":"JPY"},L=n(k),A=function(e,t){var n;if(m.indexOf(t)!==-1)n=t;else{if(g.indexOf(t)===-1)throw new Error("Invalid currency type "+t);n=k[t]}var r=accounting.unformat(e),i=money.convert(r,{from:n,to:d}),s=accounting.formatMoney(i,v,2);return s},O=function(e){$(e).contents().each(function(e){if(this.nodeType===3){var t=this.textContent,n=t,r=!1,s=t.match(T),o=t.match(C),u,c;if(s&&o){u=t.match(N);for(c=0;c<s.length;c++){if(!s[c]||!o[c])break;r=!0;var p=s[c],d=o[c],v=A(p,d);t=t.replace(u[c],i(p,v,"price"))}}var m=!1,g=t.match(f);if(g){u=t.match(l);var y=t.match(a);for(c=0;c<g.length;c++){if(!g[c])break;m=!0;var b=g[c],w=h(b,y[c]);w!==null&&(t=t.replace(u[c],i(b,w,"time")))}}if(r||m){var E=$("<span>");E.attr("data-original-text",n),E.html(t),$(this).replaceWith(E)}}else this.nodeType===1&&this.nodeName.toLowerCase()!=="iframe"&&O(this)})},M=function(e){$(e).contents().each(function(e){if(this.nodeType===1&&this.nodeName.toLowerCase()!=="iframe"){if(this.nodeName.toLowerCase()==="span"){var t=$(this),n=t.attr("data-original-text");if(n){var r=document.createTextNode(n);$(this).replaceWith(r);return}}M(this)}})},_,D=function(){for(var e=0;e<_.length;e++)if(!_[e])return;v=L[d]||d+" ",money.base="USD",O("body"),$(".converted-value").on("mouseenter",function(){$(this).find(".converted-value-hover").show()}).on("mouseout",function(){$(this).find(".converted-value-hover").hide()}),$(".converted-value-hover").each(function(){var e=$(this);e.css("bottom",-(e.height()+10))})};Localisr.isConverted?(Localisr.isConverted=!1,M("body")):(Localisr.isConverted=!0,_=[!1,!1,!1],chrome.extension.sendMessage({method:"getExchangeRates"},function(e){money.rates=e.rates,_[0]=!0,D()}),chrome.extension.sendMessage({method:"getLocaleSettings"},function(e){d=e.currency||"AED",c=e.timezone||"UTC",_[1]=!0,D()}),chrome.extension.sendMessage({method:"getTimezones"},function(n){s=n;var r=[];for(var i in s)r.push(i);o="("+r.join("|")+"){1}",u="[0-9]{1,2}\\s*:\\s*[0-9]{2}\\s*((am)|(pm))?\\s*"+o,a=new RegExp(o,"g"),f=new RegExp(e+u+t,"gi"),l=new RegExp(u,"gi"),_[2]=!0,D()}))})();