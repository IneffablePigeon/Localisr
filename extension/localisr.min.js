/*! Localisr - v0.1.2 - 2012-09-13
* http://github.com/IneffablePigeon/Localisr
* Copyright (c) 2012 Giles Lavelle, Oliver Lane; Licensed MIT */
(function(){window.Localisr=window.Localisr||{};var a="(^|\\s)+",b="($|\\s)+",c=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[a[c]]=c);return b},d={position:"absolute",left:0,background:"#eee",border:"1px solid #222",padding:"5px",display:"none",zIndex:10},e=function(a,b,c){var e=$("<span>").addClass("converted-value-hover").css(d).text("Original "+c+": "+a),f=$("<span>").text(b).addClass("converted-value").css("position","relative").append(e);return $("<div>").html(f).html()},f,g,h,i,j,k,l,m=function(a,b,c){c=c||":";var d,e,g,h=f[b];a.match(/am|pm/i)?g="hh"+c+"mm a":g="HH"+c+"mm",e=g,d=g+" Z";var i=a.substring(0,a.length-4)+h.string,j=moment(i,d);return j.local(),j.format(e)+" "+l},n,o,p=["AED","AFN","ALL","AMD","ANG","AOA","ARS","AUD","AWG","AZN","BAM","BBD","BDT","BGN","BHD","BIF","BMD","BND","BOB","BRL","BSD","BTN","BWP","BYR","BZD","CAD","CDF","CHF","CLF","CLP","CNY","COP","CRC","CUP","CVE","CZK","DJF","DKK","DOP","DZD","EGP","ETB","EUR","FJD","FKP","GBP","GEL","GHS","GIP","GMD","GNF","GTQ","GYD","HKD","HNL","HRK","HTG","HUF","IDR","ILS","INR","IQD","IRR","ISK","JMD","JOD","JPY","KES","KGS","KHR","KMF","KPW","KRW","KWD","KZT","LAK","LBP","LKR","LRD","LSL","LTL","LVL","LYD","MAD","MDL","MGA","MKD","MMK","MNT","MOP","MRO","MUR","MVR","MWK","MXN","MYR","MZN","NAD","NGN","NIO","NOK","NPR","NZD","OMR","PAB","PEN","PGK","PHP","PKR","PLN","PYG","QAR","RON","RSD","RUB","RWF","SAR","SBD","SCR","SDG","SEK","SGD","SHP","SLL","SOS","SRD","STD","SVC","SYP","SZL","THB","TJS","TMT","TND","TOP","TRY","TTD","TWD","TZS","UAH","UGX","USD","UYU","UZS","VEF","VND","VUV","WST","XAF","XCD","XDR","XOF","XPF","YER","ZAR","ZMK","ZWL"],q=["£","€","¥","$"],r=[],s,t="[0-9]+\\.?([0-9]{2})?";for(s=0;s<p.length;s++)r.push(p[s]);for(s=0;s<q.length;s++){var u=q[s];u==="$"&&(u="\\$"),r.push(u)}var v="("+r.join("|")+"){1}",w=v+"\\s*"+t,x=new RegExp(a+w+b,"g"),y=new RegExp(w,"g"),z=new RegExp(v,"g"),A={"£":"GBP",$:"USD","€":"EUR","¥":"JPY"},B=c(A),C=function(a,b){var c;if(p.indexOf(b)!==-1)c=b;else if(q.indexOf(b)!==-1)c=A[b];else throw new Error("Invalid currency type "+b);var d=accounting.unformat(a),e=money.convert(d,{from:c,to:n}),f=accounting.formatMoney(e,o,2);return f},D=function(a){$(a).contents().each(function(a){if(this.nodeType===3){var b=this.textContent,c=b,d=!1,f=b.match(x),g=b.match(z),h,l;if(f&&g){h=b.match(y);for(l=0;l<f.length;l++){if(!f[l]||!g[l])break;d=!0;var n=f[l],o=g[l],p=C(n,o);b=b.replace(h[l],e(n,p,"price"))}}var q=!1,r=b.match(j);if(r){h=b.match(k);var s=b.match(i);for(l=0;l<r.length;l++){if(!r[l])break;q=!0;var t=r[l],u=m(t,s[l]);u!==null&&(b=b.replace(h[l],e(t,u,"time")))}}if(d||q){var v=$("<span>");v.attr("data-original-text",c),v.html(b),$(this).replaceWith(v)}}else this.nodeType===1&&this.nodeName.toLowerCase()!=="iframe"&&D(this)})},E=function(a){$(a).contents().each(function(a){if(this.nodeType===1&&this.nodeName.toLowerCase()!=="iframe"){if(this.nodeName.toLowerCase()==="span"){var b=$(this),c=b.attr("data-original-text");if(c){var d=document.createTextNode(c);$(this).replaceWith(d);return}}E(this)}})},F,G=function(){for(var a=0;a<F.length;a++)if(!F[a])return;o=B[n]||n+" ",l="GMT",money.base="USD",D("body"),$(".converted-value").on("mouseenter",function(){$(this).find(".converted-value-hover").show()}).on("mouseout",function(){$(this).find(".converted-value-hover").hide()}),$(".converted-value-hover").each(function(){var a=$(this);a.css("bottom",-(a.height()+10))})};Localisr.isConverted?(Localisr.isConverted=!1,E("body")):(Localisr.isConverted=!0,F=[!1,!1,!1],chrome.extension.sendMessage({method:"getExchangeRates"},function(a){money.rates=a.data.rates,F[0]=!0,G()}),chrome.extension.sendMessage({method:"getLocalStorage",key:"currency"},function(a){n=a.data||"AED",F[1]=!0,G()}),chrome.extension.sendMessage({method:"getTimezones"},function(c){f=c;var d=[];for(var e in f)d.push(e);g="("+d.join("|")+"){1}",h="[0-9]{1,2}\\s*:\\s*[0-9]{2}\\s*((am)|(pm))?\\s*"+g,i=new RegExp(g,"g"),j=new RegExp(a+h+b,"gi"),k=new RegExp(h,"gi"),F[2]=!0,G()}))})();